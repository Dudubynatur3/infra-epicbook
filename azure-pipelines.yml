trigger:
  branches:
    include:
      - main

pool:
  name: 'Default'

variables:
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'

stages:
  - stage: Terraform
    displayName: 'Provision Infrastructure'
    jobs:
      - job: TerraformJob
        displayName: 'Run Terraform Deployment'
        steps:

          # üîê Download SSH Public Key
          - task: DownloadSecureFile@1
            name: sshPublicKey
            inputs:
              secureFile: 'id_rsa.pub'
            displayName: 'Download SSH Public Key'

          # üß© Load SSH Public Key into Variable
          - bash: |
              echo "Reading SSH public key content..."
              SSH_KEY_CONTENT=$(cat $(sshPublicKey.secureFilePath))
              echo "SSH Key loaded (length: ${#SSH_KEY_CONTENT} characters)"
              echo "##vso[task.setvariable variable=SSH_PUBLIC_KEY;issecret=true]$SSH_KEY_CONTENT"
            displayName: 'Load SSH Key into Variable'

          # üîç Debug variable presence
          - bash: |
              echo "DEBUG: checking variable lengths (0 = missing)"
              echo "MY_SQL_ADMIN_USERNAME length: ${MY_SQL_ADMIN_USERNAME}"
              echo "MY_SQL_ADMIN_PASSWORD length: ${MY_SQL_ADMIN_PASSWORD}"
              echo "SSH_PUBLIC_KEY length: ${#SSH_PUBLIC_KEY}"
            displayName: 'Debug: Variable Presence Check'
            env:
              MY_SQL_ADMIN_USERNAME: '$(MY_SQL_ADMIN_USERNAME)'
              MY_SQL_ADMIN_PASSWORD: '$(MY_SQL_ADMIN_PASSWORD)'
              SSH_PUBLIC_KEY: '$(SSH_PUBLIC_KEY)'

          # üìù Generate secret.tfvars file
          - bash: |
              echo "Generating secret.tfvars with password..."
              cat <<EOF > secret.tfvars
mysql_admin_password = "${MY_SQL_ADMIN_PASSWORD}"
EOF
              echo "secret.tfvars created."
            displayName: 'Generate secret terraform.tfvars'
            env:
              MY_SQL_ADMIN_PASSWORD: $(MY_SQL_ADMIN_PASSWORD)

          # üöÄ Terraform Init
          - task: AzureCLI@2
            displayName: 'Terraform Init'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Initializing Terraform..."
                terraform init -input=false

          # ‚úÖ Validate Terraform Config
          - task: AzureCLI@2
            displayName: 'Terraform Validate'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Validating Terraform configuration..."
                terraform validate

          # üßæ Terraform Plan
          - task: AzureCLI@2
            displayName: 'Terraform Plan'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Creating Terraform execution plan..."
                terraform plan -input=false \
                  -var="mysql_admin_username=$MY_SQL_ADMIN_USERNAME" \
                  -var="admin_ssh_public_key=$SSH_PUBLIC_KEY" \
                  -var-file=secret.tfvars \
                  -out=tfplan
            env:
              MY_SQL_ADMIN_USERNAME: '$(MY_SQL_ADMIN_USERNAME)'
              SSH_PUBLIC_KEY: '$(SSH_PUBLIC_KEY)'

          # ‚öôÔ∏è Terraform Apply
          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Applying Terraform configuration..."
                terraform apply -input=false -auto-approve tfplan
            env:
              MY_SQL_ADMIN_USERNAME: '$(MY_SQL_ADMIN_USERNAME)'
              SSH_PUBLIC_KEY: '$(SSH_PUBLIC_KEY)'

          # üì§ Show Terraform Outputs
          - task: AzureCLI@2
            displayName: 'Show Terraform Outputs'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "=========================================="
                echo "      TERRAFORM INFRASTRUCTURE OUTPUTS"
                echo "=========================================="
                echo ""

                if terraform output -json > terraform-outputs.json 2>/dev/null; then
                  echo "‚úÖ Terraform outputs file generated."
                else
                  echo "{}" > terraform-outputs.json
                  echo "‚ö†Ô∏è No outputs found ‚Äî empty file created instead."
                fi

                FRONTEND_IP=$(terraform output -raw frontend_public_ip 2>/dev/null || echo "N/A")
                BACKEND_IP=$(terraform output -raw backend_public_ip 2>/dev/null || echo "N/A")
                MYSQL_FQDN=$(terraform output -raw mysql_fqdn 2>/dev/null || echo "N/A")

                echo "üìç Frontend Public IP: $FRONTEND_IP"
                echo "üìç Backend Public IP: $BACKEND_IP"
                echo "üìç MySQL FQDN: $MYSQL_FQDN"
                echo ""
                echo "=========================================="
                echo "   Update ansible/inventory.ini & vars"
                echo "=========================================="

          # üì¶ Publish Terraform Outputs
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Outputs'
            inputs:
              PathtoPublish: '$(workingDirectory)/terraform-outputs.json'
              ArtifactName: 'terraform-outputs'
              publishLocation: 'Container'
            condition: succeededOrFailed()
