trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'

stages:
  - stage: Terraform
    displayName: 'Provision Infrastructure'
    jobs:
      - job: TerraformJob
        displayName: 'Run Terraform'
        steps:
          # Step 1: Install Terraform
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          # Step 2: Terraform Init
          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(workingDirectory)'
              backendServiceArm: 'epicbook-infra-connection'

          # Step 3: Terraform Validate
          - task: TerraformTaskV4@4
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(workingDirectory)'

          # Step 4: Terraform Plan
          - task: TerraformTaskV4@4
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(workingDirectory)'
              environmentServiceNameAzureRM: 'epicbook-infra-connection'

          # Step 5: Terraform Apply
          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(workingDirectory)'
              environmentServiceNameAzureRM: 'epicbook-infra-connection'
              commandOptions: '-auto-approve'

          # Step 6: Display Terraform Outputs
          - script: |
              echo "=========================================="
              echo "         TERRAFORM OUTPUTS"
              echo "=========================================="
              terraform output -json
              echo ""
              echo "üìç Frontend Public IP:"
              terraform output -raw frontend_public_ip || echo "Not found"
              echo ""
              echo "üìç Backend Public IP:"
              terraform output -raw backend_public_ip || echo "Not found"
              echo ""
              echo "üìç MySQL FQDN:"
              terraform output -raw mysql_fqdn || echo "Not found"
              echo "=========================================="
            displayName: 'Show Terraform Outputs'
            workingDirectory: '$(workingDirectory)'
