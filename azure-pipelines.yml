trigger:
  branches:
    include:
      - main

pool:
  name: 'Default'

variables:
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/infra-epicbook'

  # Service Principal credentials for Terraform
  - name: ARM_CLIENT_ID
    value: '526b8d33-950f-470e-8f22-dfff02a54aa4'
  - name: ARM_CLIENT_SECRET
    value: '2eG8Q-PRJRW39wNSmG7yqtzeIcG2~k0hXpjL6csg'
  - name: ARM_TENANT_ID
    value: '92847201-d5b8-45af-8606-3e1d0d0568e2'
  - name: ARM_SUBSCRIPTION_ID
    value: '<your-subscription-id>' # Replace with your Azure subscription ID

stages:
  - stage: Terraform
    displayName: 'Provision Infrastructure'
    jobs:
      - job: TerraformJob
        displayName: 'Run Terraform'
        steps:
          # Step 1: Terraform Init
          - script: |
              cd $(workingDirectory)
              terraform init
            displayName: 'Terraform Init'

          # Step 2: Terraform Validate
          - script: |
              cd $(workingDirectory)
              terraform validate
            displayName: 'Terraform Validate'

          # Step 3: Terraform Plan
          - script: |
              cd $(workingDirectory)
              terraform plan -out=tfplan
            displayName: 'Terraform Plan'

          # Step 4: Terraform Apply
          - script: |
              cd $(workingDirectory)
              terraform apply -auto-approve tfplan
            displayName: 'Terraform Apply'

          # Step 5: Display Outputs
          - script: |
              cd $(workingDirectory)
              echo "=========================================="
              echo "         TERRAFORM OUTPUTS"
              echo "=========================================="
              terraform output -json
              echo ""
              echo "üìç Frontend Public IP:" 
              terraform output -raw frontend_public_ip || echo "Not found"
              echo ""
              echo "üìç Backend Public IP:" 
              terraform output -raw backend_public_ip || echo "Not found"
              echo ""
              echo "üìç MySQL FQDN:" 
              terraform output -raw mysql_fqdn || echo "Not found"
              echo "=========================================="
            displayName: 'Show Terraform Outputs'
