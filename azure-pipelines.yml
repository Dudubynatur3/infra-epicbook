trigger:
  branches:
    include:
      - main

pool:
  name: 'Default'

variables:
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'

stages:
  - stage: Terraform
    displayName: 'Provision Infrastructure'
    jobs:
      - job: TerraformJob
        displayName: 'Run Terraform Deployment'
        steps:

          # ğŸ” Download SSH Public Key from Secure Files
          - task: DownloadSecureFile@1
            name: sshPublicKey
            inputs:
              secureFile: 'id_rsa.pub'
            displayName: 'Download SSH Public Key'

          # ğŸ§© Load SSH Public Key into Variable
          - bash: |
              echo "Reading SSH public key content..."
              SSH_KEY_CONTENT=$(cat $(sshPublicKey.secureFilePath))
              echo "SSH Key loaded (length: ${#SSH_KEY_CONTENT} characters)"
              echo "##vso[task.setvariable variable=SSH_PUBLIC_KEY;issecret=true]$SSH_KEY_CONTENT"
            displayName: 'Load SSH Key into Variable'

          # ğŸš€ Terraform Init (Authenticate with Azure CLI)
          - task: AzureCLI@2
            displayName: 'Terraform Init'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Initializing Terraform..."
                terraform init -input=false

          # âœ… Validate Terraform Config
          - task: AzureCLI@2
            displayName: 'Terraform Validate'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Validating Terraform configuration..."
                terraform validate

          # ğŸ§¾ Terraform Plan (Inject Variables)
          - task: AzureCLI@2
            displayName: 'Terraform Plan'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Creating Terraform execution plan..."
                terraform plan -input=false \
                  -var="admin_ssh_public_key=$(SSH_PUBLIC_KEY)" \
                  -var="mysql_admin_username=$(MYSQL_ADMIN_USERNAME)" \
                  -var="mysql_admin_password=$(MYSQL_ADMIN_PASSWORD)" \
                  -out=tfplan

          # âš™ï¸ Terraform Apply (Auto-Approve)
          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Applying Terraform configuration..."
                terraform apply -input=false -auto-approve tfplan

          # ğŸ“¤ Export and Show Terraform Outputs
          - task: AzureCLI@2
            displayName: 'Show Terraform Outputs'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "=========================================="
                echo "      TERRAFORM INFRASTRUCTURE OUTPUTS"
                echo "=========================================="
                echo ""

                terraform output -json | tee terraform-outputs.json

                FRONTEND_IP=$(terraform output -raw frontend_public_ip 2>/dev/null || echo "N/A")
                BACKEND_IP=$(terraform output -raw backend_public_ip 2>/dev/null || echo "N/A")
                MYSQL_FQDN=$(terraform output -raw mysql_fqdn 2>/dev/null || echo "N/A")

                echo "ğŸ“ Frontend Public IP: $FRONTEND_IP"
                echo "ğŸ“ Backend Public IP: $BACKEND_IP"
                echo "ğŸ“ MySQL FQDN: $MYSQL_FQDN"
                echo ""
                echo "=========================================="
                echo "   Update ansible/inventory.ini & vars"
                echo "=========================================="

          # ğŸ—‚ï¸ Publish Terraform Outputs Artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Outputs'
            inputs:
              PathtoPublish: '$(workingDirectory)/terraform-outputs.json'
              ArtifactName: 'terraform-outputs'
              publishLocation: 'Container'
            condition: succeededOrFailed()
