trigger:
  branches:
    include:
      - main

pool:
  name: 'Default'

variables:
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'

stages:
  - stage: Terraform
    displayName: 'Provision Infrastructure'
    jobs:
      - job: TerraformJob
        displayName: 'Run Terraform'
        steps:
          # ‚úÖ NEW: Download SSH Public Key from Secure Files
          - task: DownloadSecureFile@1
            name: sshPublicKey
            inputs:
              secureFile: 'id_rsa.pub'
            displayName: 'Download SSH Public Key from Secure Files'

          # ‚úÖ NEW: Read SSH Key Content into Variable
          - bash: |
              echo "Reading SSH public key content..."
              SSH_KEY_CONTENT=$(cat $(sshPublicKey.secureFilePath))
              echo "SSH Key loaded (length: ${#SSH_KEY_CONTENT} characters)"
              echo "##vso[task.setvariable variable=SSH_PUBLIC_KEY;issecret=true]$SSH_KEY_CONTENT"
            displayName: 'Load SSH Public Key into Variable'

          # ‚úÖ UPDATED: Terraform Init with Azure CLI authentication
          - task: AzureCLI@2
            displayName: 'Terraform Init'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Initializing Terraform..."
                terraform init -input=false

          # ‚úÖ UPDATED: Terraform Validate with Azure CLI authentication
          - task: AzureCLI@2
            displayName: 'Terraform Validate'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Validating Terraform configuration..."
                terraform validate

          # ‚úÖ UPDATED: Terraform Plan with SSH Key Variable
          - task: AzureCLI@2
            displayName: 'Terraform Plan'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Creating Terraform execution plan..."
                terraform plan -input=false \
                  -var="admin_ssh_public_key=$(SSH_PUBLIC_KEY)" \
                  -out=tfplan

          # ‚úÖ UPDATED: Terraform Apply with SSH Key Variable
          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "Applying Terraform configuration..."
                terraform apply -input=false -auto-approve tfplan

          # ‚úÖ UPDATED: Show Outputs
          - task: AzureCLI@2
            displayName: 'Show Terraform Outputs'
            inputs:
              azureSubscription: 'epicbook-infra-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(workingDirectory)'
              inlineScript: |
                echo "=========================================="
                echo "      TERRAFORM INFRASTRUCTURE OUTPUTS"
                echo "=========================================="
                echo ""
                
                # Save outputs to JSON
                terraform output -json | tee terraform-outputs.json
                
                echo ""
                echo "=========================================="
                echo "   üìã COPY THESE FOR YOUR APP PIPELINE:"
                echo "=========================================="
                echo ""
                
                # Display individual outputs
                FRONTEND_IP=$(terraform output -raw frontend_public_ip 2>/dev/null || echo "Not available")
                BACKEND_IP=$(terraform output -raw backend_public_ip 2>/dev/null || echo "Not available")
                MYSQL_FQDN=$(terraform output -raw mysql_fqdn 2>/dev/null || echo "Not available")
                
                echo "üìç Frontend Public IP: $FRONTEND_IP"
                echo "üìç Backend Public IP: $BACKEND_IP"
                echo "üìç MySQL FQDN: $MYSQL_FQDN"
                echo ""
                echo "=========================================="
                echo "      UPDATE YOUR APP REPOSITORY WITH:"
                echo "=========================================="
                echo ""
                echo "1. ansible/inventory.ini:"
                echo "   [frontend]"
                echo "   $FRONTEND_IP"
                echo ""
                echo "   [backend]"
                echo "   $BACKEND_IP"
                echo ""
                echo "2. ansible/group_vars/backend.yml:"
                echo "   db_host: $MYSQL_FQDN"
                echo ""
                echo "3. ansible/group_vars/frontend.yml:"
                echo "   backend_api_url: http://$BACKEND_IP:5000"
                echo ""
                echo "=========================================="

          # ‚úÖ NEW: Publish Outputs as Artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Outputs'
            inputs:
              PathtoPublish: '$(workingDirectory)/terraform-outputs.json'
              ArtifactName: 'terraform-outputs'
              publishLocation: 'Container'
            condition: succeededOrFailed()